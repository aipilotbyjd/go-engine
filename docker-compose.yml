# LinkFlow Go Engine - Docker Compose
# Connects to external 'linkflow' network (start infrastructure first)
#
# Usage:
#   docker-compose up -d              # Start worker only
#   docker-compose --profile full up  # Start all services

services:
  # ============================================
  # Worker - Core execution engine
  # ============================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: worker
    container_name: linkflow-worker
    restart: unless-stopped
    ports:
      - "8083:8080"
    environment:
      # Database
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
      # Redis
      REDIS_URL: redis://linkflow-redis:6379
      # Logging
      LOG_LEVEL: debug
      # Callback to Laravel API
      CALLBACK_URL: http://linkflow-api:8000/api/v1/jobs/callback
      CALLBACK_SECRET: ${LINKFLOW_SECRET:-your-shared-secret-change-in-production}
    networks:
      - linkflow
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Migrations - One-time job
  # ============================================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: worker
    container_name: linkflow-go-migrate
    environment:
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
    entrypoint: []
    command: >
      sh -c "
        echo 'Running Go Engine migrations...' &&
        cd /app &&
        ls -la &&
        echo 'Migrations complete!'
      "
    networks:
      - linkflow
    profiles:
      - migrate

  # ============================================
  # Frontend Gateway (Optional)
  # ============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: frontend
    container_name: linkflow-go-frontend
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
      REDIS_URL: redis://linkflow-redis:6379
      LOG_LEVEL: debug
    networks:
      - linkflow
    profiles:
      - full

  # ============================================
  # History Service (Optional)
  # ============================================
  history:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: history
    container_name: linkflow-go-history
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
      REDIS_URL: redis://linkflow-redis:6379
      LOG_LEVEL: debug
    networks:
      - linkflow
    profiles:
      - full

  # ============================================
  # Matching Service (Optional)
  # ============================================
  matching:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: matching
    container_name: linkflow-go-matching
    restart: unless-stopped
    ports:
      - "8082:8080"
    environment:
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
      REDIS_URL: redis://linkflow-redis:6379
      LOG_LEVEL: debug
    networks:
      - linkflow
    profiles:
      - full

  # ============================================
  # Timer Service (Optional)
  # ============================================
  timer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: timer
    container_name: linkflow-go-timer
    restart: unless-stopped
    ports:
      - "8084:8080"
    environment:
      DATABASE_URL: postgres://linkflow:linkflow@linkflow-postgres:5432/linkflow?sslmode=disable
      REDIS_URL: redis://linkflow-redis:6379
      LOG_LEVEL: debug
    networks:
      - linkflow
    profiles:
      - full

networks:
  linkflow:
    external: true
